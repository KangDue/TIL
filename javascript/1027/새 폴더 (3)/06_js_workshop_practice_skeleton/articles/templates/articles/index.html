{% extends 'base.html' %}

{% block content %}
  <h1>Articles</h1>
  {% if request.user.is_authenticated %}
    <a href="{% url 'articles:create' %}">[CREATE]</a>
  {% else %}
    <a href="{% url 'accounts:login' %}">[새 글을 작성하려면 로그인하세요.]</a>
  {% endif %}
  <hr>
  {% for article in articles %}
    <p>작성자 : 
      <a href="{% url 'accounts:profile' article.user.username %}">{{ article.user }}</a>
    </p>
    <p>글 번호 : {{ article.pk }}</p>
    <p>글 제목 : {{ article.title }}</p>
    <p>글 내용 : {{ article.content }}</p>
    <div>
      {% comment %} action이 없으면 현재 page로 get으로 csrf를 보내버림. 신경쓸 필요 x {% endcomment %}
      {% comment %} 각각의 form tag마다 각각의 pk 가지고 있음. {% endcomment %}
      <form class="like-form" data-article-id="{{ article.pk }}">
        {% csrf_token %}
        {% if user in article.like_users.all %}
          {% comment %} id는 항상 문자열이어야 한다. 지멋대로 형변환 때문 {% endcomment %}
          <button id="like-{{ article.pk }}">좋아요 취소</button>
        {% else %}
          <button id="like-{{ article.pk }}">좋아요</button>
        {% endif %}
      </form>
      <p>
        <span id="like-count-{{ article.pk }}">
          {{ article.like_users.all|length }}
        </span>
        명이 이 글을 좋아합니다.
      </p>
    </div>
    <a href="{% url 'articles:detail' article.pk %}">[DETAIL]</a>
    <hr>
  {% endfor %}
{% endblock content %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // CODE HERE
    const forms = document.querySelectorAll('.like-form')
    // 이런식으로 가능
    // document.querySelector('form[data-article-id="2"]')  
    forms.forEach((form) => { 
      
      //let form_id = form.getAttribute('data-article-id')
      form.addEventListener('submit',function (event) {
        event.preventDefault()
        let formId = event.target.dataset.articleId
        // name=csrfmiddlewaretoken 이라는 속성 가짐.
        // 한 페이지 안에서 csrf 토큰 값은 모두 같은 값을 가짐.
        // html 렌더링시 csrf를 장고가 생성하니까 아무거나 1개 가져와도 되는 것
        // let {formId} = event.target.dataset
        let csrfToken = event.target.querySelector('input').value
        console.log(csrfToken)
        axios({
          method:"POST",
          url:`/articles/${ formId }/likes/`, // slash 잘 넣어야함
          headers:{'X-CSRFToken':csrfToken},
        })
        .then((response)=>{
          //console.log(response)
          let btn = event.target.querySelector('button')
          btn.innerText = response.data.isLiked ? '좋아요 취소':'좋아요'
        })
        .catch((response) => {
          console.log(response)
          console.log(location)
          location.pathname=''
          location.href = '/accounts/login/' // slash 앞뒤로 잘 넣어야함.
        })

      })
     })
  </script>
{% endblock script %}
{% comment %} https://velog.io/@gene028/%EA%B0%9C%EB%B0%9C%EC%9D%BC%EC%A7%80-2-CSRF-%ED%86%A0%ED%81%B0%EC%9D%B4-%EB%82%A0-%EA%B4%B4%EB%A1%AD%ED%9E%8C%EB%8B%A4 {% endcomment %}
{% comment %} csrf 참고 {% endcomment %}